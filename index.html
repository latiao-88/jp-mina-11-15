<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    
    <!-- æ ¸å¿ƒä¿®æ”¹ï¼šå›¾æ ‡å·²è®¾ç½®ä¸ºâ€œ4â€ -->
    <link rel="apple-touch-icon" href="https://ui-avatars.com/api/?name=4&background=007aff&color=fff&size=512&font-size=0.6&length=1">

    <title>ç¬¬4è¯¾ - å¤§å®¶çš„æ—¥è¯­</title>
    <style>
        :root { --primary: #007aff; --bg: #f2f2f7; --mask-bg: #d1d1d6; }
        body { font-family: -apple-system, "Helvetica Neue", sans-serif; background: var(--bg); margin: 0; display: flex; flex-direction: column; height: 100vh; overflow: hidden; }
        
        .header { padding: 15px; text-align: center; background: #fff; font-weight: bold; border-bottom: 1px solid #ddd; z-index: 10; font-size: 1.1rem; flex-shrink: 0;}
        .container { flex: 1; padding: 15px; overflow-y: auto; display: flex; justify-content: center; align-items: flex-start; -webkit-overflow-scrolling: touch;}
        .card { background: #fff; width: 100%; max-width: 500px; border-radius: 16px; padding: 15px; box-shadow: 0 4px 12px rgba(0,0,0,0.08); text-align: center; margin-bottom: 40px;}
        
        .tag { background: #e5e5ea; color: #666; padding: 4px 10px; border-radius: 6px; font-size: 0.9rem; margin-bottom: 15px; display: inline-block; font-weight: bold;}

        /* === å¸ƒå±€ === */
        .dialogue-row { display: flex; align-items: flex-start; padding: 12px 0; border-bottom: 1px solid #f0f0f0; }
        .play-col { width: 40px; display: flex; flex-direction: column; align-items: center; justify-content: center; margin-right: 10px; padding-top: 5px; }
        .play-icon { font-size: 1.4rem; color: var(--primary); cursor: pointer; background: #eef7ff; width: 36px; height: 36px; border-radius: 50%; display: flex; align-items: center; justify-content: center; transition: 0.2s; }
        .play-icon:active { background: #007aff; color: white; transform: scale(0.9); }
        .text-col { flex: 1; text-align: left; }
        
        /* è§’è‰²æ ‡ç­¾ */
        .role-tag { font-size: 0.7rem; font-weight: bold; color: white; padding: 2px 6px; border-radius: 4px; margin-right: 5px; vertical-align: middle; display: inline-block; margin-bottom: 4px;}
        .role-m { background-color: #5856d6; } /* ç”·å£°/ç±³å‹’ */
        .role-f { background-color: #ff2d55; } /* å¥³å£°/ä½è—¤/åº—å‘˜ */
        
        /* é®æŒ¡æ¡ */
        .text-block { transition: all 0.2s; border-radius: 6px; padding: 6px 8px; cursor: pointer; display: block; margin-bottom: 6px; line-height: 1.5; border: 1px solid transparent; }
        .masked { background-color: var(--mask-bg); color: transparent !important; position: relative; border-color: transparent; user-select: none;}
        .masked::after { content: ''; position: absolute; left: 50%; top: 50%; transform: translate(-50%, -50%); width: 8px; height: 8px; background: #999; border-radius: 50%; }

        .jp-text { font-size: 1.15rem; font-weight: bold; color: #000; }
        .cn-text { font-size: 0.95rem; color: #666; }
        .playing-row { background-color: #f0f9ff; border-radius: 8px; }

        /* åº•éƒ¨æ§åˆ¶æ  */
        .controls { padding: 15px; background: #fff; border-top: 1px solid #ddd; flex-shrink: 0; padding-bottom: env(safe-area-inset-bottom);}
        .row { display: flex; gap: 10px; margin-bottom: 8px; }
        button { border: none; padding: 12px; border-radius: 10px; font-size: 0.95rem; font-weight: bold; cursor: pointer; display: flex; justify-content: center; align-items: center; touch-action: manipulation;}
        .btn-green { background: #34c759; color: white; width: 100%; font-size: 1rem; margin-bottom: 10px; padding: 14px;}
        .btn-green:active { background: #248a3d; }
        .btn-nav { background: #eee; color: #333; flex: 1; }
        .btn-toggle { background: #fff; border: 1px solid #ccc; color: #333; flex: 1; }
        .btn-toggle.active { background: #007aff; color: white; border: none; }
        #status-bar { font-size: 10px; color: #999; text-align: center; margin-top: 5px; height: 15px;}
    </style>
</head>
<body>

    <div class="header" id="headerTitle">ç¬¬4è¯¾</div>

    <div class="container">
        <div id="cardArea" class="card"></div>
    </div>

    <div class="controls">
        <div id="status-bar">å‡†å¤‡å°±ç»ª</div>
        <div class="row">
            <button class="btn-toggle" id="btnJp" onclick="toggleGlobal('jp')">å…¨æ˜¾æ—¥æ–‡</button>
            <button class="btn-toggle" id="btnCn" onclick="toggleGlobal('cn')">å…¨æ˜¾ä¸­æ–‡</button>
        </div>
        <div class="row">
            <button class="btn-nav" onclick="changeCard(-1)">â¬…ï¸ ä¸Šä¸€æ¡</button>
            <button class="btn-nav" onclick="changeCard(1)">ä¸‹ä¸€æ¡ â¡ï¸</button>
        </div>
    </div>

    <script>
        // ===============================================
        // æ•°æ®åŒºï¼šç¬¬4è¯¾
        // ===============================================
        const lessonData = [
            // --- ç»ƒä¹  1-7 (å›¾ç‰‡1) ---
            { 
                category: 'ç»ƒä¹  1', 
                lines: [
                    { role: 'Q', gender: 'f', jp: 'ä»Šã€€ä½•æ™‚ã§ã™ã‹ã€‚', cn: 'ç°åœ¨å‡ ç‚¹ï¼Ÿ' }, 
                    { role: 'A', gender: 'm', jp: '2æ™‚10åˆ†ã§ã™ã€‚', cn: '2ç‚¹10åˆ†ã€‚' },
                    { role: 'Q', gender: 'f', jp: 'ãƒ‹ãƒ¥ãƒ¼ãƒ¨ãƒ¼ã‚¯ã¯ã€€ä»Šã€€ä½•æ™‚ã§ã™ã‹ã€‚', cn: 'çº½çº¦ç°åœ¨å‡ ç‚¹ï¼Ÿ' }, 
                    { role: 'A', gender: 'm', jp: 'åˆå‰ã€€0æ™‚10åˆ†ã§ã™ã€‚', cn: 'ä¸Šåˆ0ç‚¹10åˆ†ã€‚' }
                ] 
            },
            { 
                category: 'ç»ƒä¹  2', 
                lines: [
                    { role: 'Q', gender: 'f', jp: 'ä¼‘ã¿ã¯ã€€ä½•æ›œæ—¥ã§ã™ã‹ã€‚', cn: 'ä¼‘æ¯æ—¥æ˜¯æ˜ŸæœŸå‡ ï¼Ÿ' }, 
                    { role: 'A', gender: 'm', jp: 'åœŸæ›œæ—¥ã¨ã€€æ—¥æ›œæ—¥ã§ã™ã€‚', cn: 'æ˜¯æ˜ŸæœŸå…­å’Œæ˜ŸæœŸæ—¥ã€‚' }
                ] 
            },
            { 
                category: 'ç»ƒä¹  3', 
                lines: [
                    { role: 'Q', gender: 'f', jp: 'ã‚¢ãƒƒãƒ—ãƒ«éŠ€è¡Œã¯ã€€ä½•æ™‚ã‹ã‚‰ã€€ä½•æ™‚ã¾ã§ã§ã™ã‹ã€‚', cn: 'è‹¹æœé“¶è¡Œä»å‡ ç‚¹åˆ°å‡ ç‚¹è¥ä¸šï¼Ÿ' }, 
                    { role: 'A', gender: 'm', jp: '9æ™‚ã‹ã‚‰ã€€3æ™‚ã¾ã§ã§ã™ã€‚', cn: 'ä»9ç‚¹åˆ°3ç‚¹ã€‚' }
                ] 
            },
            { 
                category: 'ç»ƒä¹  4', 
                lines: [
                    { role: 'Q', gender: 'f', jp: 'æ¯æ™©ã€€ä½•æ™‚ã«ã€€å¯ã¾ã™ã‹ã€‚', cn: 'æ¯æ™šå‡ ç‚¹ç¡è§‰ï¼Ÿ' }, 
                    { role: 'A', gender: 'm', jp: '11æ™‚ã«ã€€å¯ã¾ã™ã€‚', cn: '11ç‚¹ç¡è§‰ã€‚' }
                ] 
            },
            { 
                category: 'ç»ƒä¹  5', 
                lines: [
                    { role: 'Q', gender: 'f', jp: 'æ¯æ—¥ã€€ä½•æ™‚ã‹ã‚‰ã€€ä½•æ™‚ã¾ã§ã€€å‹‰å¼·ã—ã¾ã™ã‹ã€‚', cn: 'æ¯å¤©ä»å‡ ç‚¹åˆ°å‡ ç‚¹å­¦ä¹ ï¼Ÿ' }, 
                    { role: 'A', gender: 'm', jp: 'æœã€€9æ™‚ã‹ã‚‰ã€€åˆå¾Œã€€3æ™‚ã¾ã§ã€€å‹‰å¼·ã—ã¾ã™ã€‚', cn: 'ä»æ—©ä¸Š9ç‚¹å­¦åˆ°ä¸‹åˆ3ç‚¹ã€‚' }
                ] 
            },
            { 
                category: 'ç»ƒä¹  6', 
                lines: [
                    { role: 'Q', gender: 'f', jp: 'åœŸæ›œæ—¥ã€€åƒãã¾ã™ã‹ã€‚', cn: 'æ˜ŸæœŸå…­å·¥ä½œå—ï¼Ÿ' }, 
                    { role: 'A', gender: 'm', jp: 'â€¦â€¦ã„ã„ãˆã€åƒãã¾ã›ã‚“ã€‚', cn: 'â€¦â€¦ä¸ï¼Œä¸å·¥ä½œã€‚' }
                ] 
            },
            { 
                category: 'ç»ƒä¹  7', 
                lines: [
                    { role: 'Q', gender: 'f', jp: 'ãã®ã†ã€€å‹‰å¼·ã—ã¾ã—ãŸã‹ã€‚', cn: 'æ˜¨å¤©å­¦ä¹ äº†å—ï¼Ÿ' }, 
                    { role: 'A', gender: 'm', jp: 'â€¦â€¦ã„ã„ãˆã€å‹‰å¼·ã—ã¾ã›ã‚“ã§ã—ãŸã€‚', cn: 'â€¦â€¦ä¸ï¼Œæ²¡å­¦ä¹ ã€‚' }
                ] 
            },

            // --- ä¼šè¯ (å›¾ç‰‡2) ---
            {
                category: 'ä¼šè¯ 1ï¼šè¯¢é—®ç”µè¯å·ç ',
                lines: [
                    { role: 'ãƒŸãƒ©ãƒ¼', gender: 'm', jp: 'ã™ã¿ã¾ã›ã‚“ã€ã€Œã‚ã™ã‹ã€ã®ã€€é›»è©±ç•ªå·ã¯ã€€ä½•ç•ªã§ã™ã‹ã€‚', cn: 'å¯¹ä¸èµ·ï¼Œè¯·é—®â€œAsukaâ€çš„ç”µè¯å·ç æ˜¯å¤šå°‘ï¼Ÿ' },
                    { role: 'ä½è—¤', gender: 'f', jp: 'ã€Œã‚ã™ã‹ã€ã§ã™ã‹ã€‚5275ã®ã€€2725ã§ã™ã€‚', cn: 'â€œAsukaâ€å—ï¼Ÿæ˜¯5275-2725ã€‚' },
                    { role: 'ãƒŸãƒ©ãƒ¼', gender: 'm', jp: 'ã©ã†ã‚‚ã€€ã‚ã‚ŠãŒã¨ã†ã€€ã”ã–ã„ã¾ã™ã€‚', cn: 'éå¸¸æ„Ÿè°¢ã€‚' }
                ]
            },
            {
                category: 'ä¼šè¯ 2ï¼šé‚£è¾¹è¥ä¸šåˆ°å‡ ç‚¹',
                lines: [
                    { role: 'åº—ã®äºº', gender: 'f', jp: 'ã¯ã„ã€ã€Œã‚ã™ã‹ã€ã§ã™ã€‚', cn: 'ä½ å¥½ï¼Œè¿™é‡Œæ˜¯â€œAsukaâ€ã€‚' },
                    { role: 'ãƒŸãƒ©ãƒ¼', gender: 'm', jp: 'ã™ã¿ã¾ã›ã‚“ã€‚ãã¡ã‚‰ã¯ã€€ä½•æ™‚ã¾ã§ã§ã™ã‹ã€‚', cn: 'è¯·é—®ï¼Œä½ ä»¬é‚£é‡Œè¥ä¸šåˆ°å‡ ç‚¹ï¼Ÿ' },
                    { role: 'åº—ã®äºº', gender: 'f', jp: '10æ™‚ã¾ã§ã§ã™ã€‚', cn: 'åˆ°10ç‚¹ã€‚' },
                    { role: 'ãƒŸãƒ©ãƒ¼', gender: 'm', jp: 'ä¼‘ã¿ã¯ã€€ä½•æ›œæ—¥ã§ã™ã‹ã€‚', cn: 'ä¼‘æ¯æ—¥æ˜¯æ˜ŸæœŸå‡ ï¼Ÿ' },
                    { role: 'åº—ã®äºº', gender: 'f', jp: 'æ—¥æ›œæ—¥ã§ã™ã€‚', cn: 'æ˜¯æ˜ŸæœŸå¤©ã€‚' },
                    { role: 'ãƒŸãƒ©ãƒ¼', gender: 'm', jp: 'ãã†ã§ã™ã‹ã€‚ã©ã†ã‚‚ã€‚', cn: 'æ˜¯å—ã€‚è°¢è°¢ã€‚' }
                ]
            },

            // --- çŸ­å¯¹è¯ (å›¾ç‰‡3) ---
            {
                category: 'ç»ƒä¹ ï¼šçœŸè¾›è‹¦å•Š',
                lines: [
                    { role: 'A', gender: 'f', jp: 'ãã®ã†ã€€12æ™‚ã¾ã§ã€€å‹‰å¼·ã—ã¾ã—ãŸã€‚', cn: 'æ˜¨å¤©æˆ‘å­¦ä¹ åˆ°äº†12ç‚¹ã€‚' },
                    { role: 'B', gender: 'm', jp: 'ãã†ã§ã™ã‹ã€‚ä½•æ™‚ã«ã€€å¯ã¾ã—ãŸã‹ã€‚', cn: 'æ˜¯å—ã€‚å‡ ç‚¹ç¡çš„ï¼Ÿ' },
                    { role: 'A', gender: 'f', jp: '1æ™‚ã«ã€€å¯ã¾ã—ãŸã€‚', cn: '1ç‚¹ç¡çš„ã€‚' },
                    { role: 'B', gender: 'm', jp: 'å¤§å¤‰ã§ã™ã­ã€‚', cn: 'çœŸè¾›è‹¦å•Š/å¤Ÿå—çš„å•Šã€‚' }
                ]
            }
        ];

        // ================= çŠ¶æ€ç®¡ç† =================
        let currentIndex = 0;
        let globalShowJp = false;
        let globalShowCn = false;
        let isSeqPlaying = false;
        let voices = { male: null, female: null, default: null };

        // ================= è¯­éŸ³å¼•æ“ =================
        function loadVoices() {
            const all = window.speechSynthesis.getVoices();
            const ja = all.filter(v => v.lang.includes('ja'));
            if (ja.length > 0) {
                // å°è¯•åŒºåˆ†ç”·å¥³å£°
                voices.female = ja.find(v => v.name.includes('Kyoko') || v.name.includes('Female')) || ja[0];
                voices.male = ja.find(v => v.name.includes('Otoya') || v.name.includes('Male')) || ja[0];
                voices.default = ja[0];
                document.getElementById('status-bar').innerText = "âœ… è¯­éŸ³åŠ è½½å®Œæˆ";
            } else {
                document.getElementById('status-bar').innerText = "âš ï¸ ä½¿ç”¨é»˜è®¤è¯­éŸ³";
            }
        }
        // å…¼å®¹æ€§å¤„ç†
        if (window.speechSynthesis.onvoiceschanged !== undefined) window.speechSynthesis.onvoiceschanged = loadVoices;
        setTimeout(loadVoices, 500);

        function speak(text, gender, callback) {
            window.speechSynthesis.cancel();
            const u = new SpeechSynthesisUtterance(text);
            u.lang = 'ja-JP';
            u.rate = 0.9; // è¯­é€Ÿç¨æ…¢
            
            // å£°éŸ³åˆ†é…
            if (gender === 'm' && voices.male) u.voice = voices.male;
            else if (gender === 'f' && voices.female) u.voice = voices.female;
            else if (voices.default) u.voice = voices.default;

            // éŸ³è°ƒå¾®è°ƒ
            if (gender === 'm') u.pitch = 0.95;
            else u.pitch = 1.05;

            if (callback) u.onend = callback;
            window.speechSynthesis.speak(u);
        }

        // ================= æ¸²æŸ“é€»è¾‘ =================
        function render() {
            window.speechSynthesis.cancel();
            isSeqPlaying = false;
            
            const data = lessonData[currentIndex];
            document.getElementById('headerTitle').innerText = `${data.category} (${currentIndex + 1}/${lessonData.length})`;
            
            updateGlobalBtns();

            let html = `<div class="tag">${data.category}</div>`;
            html += `<button class="btn-green" onclick="playSequence()">â–¶ï¸ å®Œæ•´æ’­æ”¾ (åŒ…å«åœé¡¿)</button>`;
            html += `<div style="text-align:left; width:100%;">`;

            data.lines.forEach((line, idx) => {
                const jpClass = globalShowJp ? 'text-block jp-text' : 'text-block jp-text masked';
                const cnClass = globalShowCn ? 'text-block cn-text' : 'text-block cn-text masked';
                
                // è§’è‰²é¢œè‰²åˆ†é…
                let roleClass = 'role-f';
                if (line.gender === 'm') roleClass = 'role-m';

                html += `
                    <div class="dialogue-row" id="row-${idx}">
                        <div class="play-col"><div class="play-icon" onclick="playLine(${idx})">ğŸ”Š</div></div>
                        <div class="text-col">
                            ${line.role ? `<span class="role-tag ${roleClass}">${line.role}</span>` : ''}
                            <div class="${jpClass}" onclick="toggleOne(this)">${line.jp}</div>
                            <div class="${cnClass}" onclick="toggleOne(this)">${line.cn}</div>
                        </div>
                    </div>
                `;
            });
            html += `</div>`;
            document.getElementById('cardArea').innerHTML = html;
        }

        // ================= äº¤äº’é€»è¾‘ =================
        function toggleOne(el) { 
            if(el.classList.contains('masked')) el.classList.remove('masked');
            else el.classList.add('masked');
        }

        function toggleGlobal(type) {
            if (type === 'jp') globalShowJp = !globalShowJp;
            if (type === 'cn') globalShowCn = !globalShowCn;
            render();
        }

        function updateGlobalBtns() {
            const bJ = document.getElementById('btnJp');
            const bC = document.getElementById('btnCn');
            bJ.className = globalShowJp ? 'btn-toggle active' : 'btn-toggle';
            bC.className = globalShowCn ? 'btn-toggle active' : 'btn-toggle';
            bJ.innerText = globalShowJp ? 'å…¨æ˜¾æ—¥æ–‡' : 'å…¨éšæ—¥æ–‡';
            bC.innerText = globalShowCn ? 'å…¨æ˜¾ä¸­æ–‡' : 'å…¨éšä¸­æ–‡';
        }

        function playLine(idx) {
            isSeqPlaying = false;
            highlightRow(idx);
            const data = lessonData[currentIndex];
            const line = data.lines[idx];
            speak(line.jp, line.gender, () => {
                unhighlightRow(idx);
            });
        }

        function playSequence() {
            isSeqPlaying = true;
            const data = lessonData[currentIndex];
            let idx = 0;
            
            // æ¸…é™¤æ—§çš„é«˜äº®
            document.querySelectorAll('.dialogue-row').forEach(e => e.classList.remove('playing-row'));

            function next() {
                if (!isSeqPlaying || idx >= data.lines.length) {
                    isSeqPlaying = false;
                    if(idx > 0) unhighlightRow(idx-1);
                    return;
                }
                
                if (idx > 0) unhighlightRow(idx-1);
                highlightRow(idx);
                
                document.getElementById(`row-${idx}`).scrollIntoView({behavior: "smooth", block: "center"});

                const line = data.lines[idx];
                speak(line.jp, line.gender, () => {
                    idx++;
                    // å¥ä¸å¥ä¹‹é—´æš‚åœ0.6ç§’
                    setTimeout(next, 600);
                });
            }
            next();
        }

        function highlightRow(idx) {
            const el = document.getElementById(`row-${idx}`);
            if (el) el.classList.add('playing-row');
        }

        function unhighlightRow(idx) {
            const el = document.getElementById(`row-${idx}`);
            if (el) el.classList.remove('playing-row');
        }

        function changeCard(dir) {
            const next = currentIndex + dir;
            if (next >= 0 && next < lessonData.length) {
                currentIndex = next;
                render();
            }
        }

        // åˆå§‹åŒ–
        render();
    </script>
</body>
</html>
